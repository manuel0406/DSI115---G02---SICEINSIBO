<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{home :: head}">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <title>Arquivo</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>

<body>
  <header th:replace="~{home :: header}"></header>
  <div class="p-4 mt-5">
    <h2 class="text-center pb-4">Cargar archivo de asistencias</h2>
    <div class="d-flex justify-content-end py-3">
      <a type="button" class="btn btn-outline-primary" th:href="@{/asistencias/seleccionInicio}">
        Regresar
      </a>
    </div>
    <div class="w-75 mx-auto d-flex flex-column">
      <input class="form-control form-control-lg" id="input-excel" type="file">
      <div class="py-3 text-center">
        <button class="btn btn-primary" id="idCarga">Cargar Asistencias</button>
      </div>
    </div>
  </div>
  <div>
    <div id="output" class=""></div>
  </div>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
      let selectedFile;
      document.getElementById("input-excel").addEventListener("change", (e) => {
        selectedFile = e.target.files[0];
      });
  
      document.getElementById("idCarga").addEventListener("click", () => {
        if (selectedFile) {
          handleFile();
        } else {
          alert("Por favor, seleccione un archivo primero.");
        }
      });
  
      function handleFile() {
        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const output = document.getElementById("output");
            output.innerHTML = "";
            const sheetNameToFind = "Estadísticas de anormalías"; // Hoja buscada
            if (workbook.SheetNames.includes(sheetNameToFind)) {
              const sheet = workbook.Sheets[sheetNameToFind];
              const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
              let results = [];
              let columnIndexID = -1;
  
              function isValidTime(value) {
                return /^([01]\d|2[0-3]):([0-5]\d)$/.test(value);
              }
  
              function formatDate(dateStr) {
                const [day, month, year] = dateStr.split("/");
                return `${year}-${month}-${day}`;
              }
  
              function formatTimeToTwoDigits(timeStr) {
                // Asegura que el tiempo este en el formato HH:mm (e.g., "06:50" en lugar de "6:50")
                return timeStr.length === 4 ? `0${timeStr}` : timeStr;
              }
  
              // Encuentra la columna con el titulo "ID"
              for (let i = 0; i < json.length; i++) {
                let row = json[i];
                columnIndexID = row.indexOf("ID.");
                if (columnIndexID !== -1) {
                  // Encontró la columna "ID"
                  for (let j = i + 1; j < json.length; j++) {
                    let dataRow = json[j];
                    let id = dataRow[columnIndexID];
                    if (id !== undefined) {
                      let adjacentData = [];
                      for (let k = 0; k <= 6; k++) {
                        adjacentData.push(dataRow[columnIndexID + k]);
                      }
  
                      // Formatear los datos segun el formato deseado
                      const formattedDate = formatDate(adjacentData[3]);
  
                      // Verificar si los campos de "Inicio" y "Fin" periodo 1 estan presentes
                      if (
                        (adjacentData[4] || adjacentData[4] === "Falta") &&
                        (adjacentData[5] || adjacentData[5] === "Falta")
                      ) {
                        const formattedInicioMatutino = adjacentData[4] && adjacentData[4] !== "Falta" 
                          ? `${formattedDate}T${formatTimeToTwoDigits(adjacentData[4])}:00` 
                          : `${formattedDate}T01:00:00`;
                        const formattedFinMatutino = adjacentData[5] && adjacentData[5] !== "Falta" 
                          ? `${formattedDate}T${formatTimeToTwoDigits(adjacentData[5])}:00` 
                          : `${formattedDate}T01:00:00`;
  
                        // Agregar datos para periodo solo si Inicio o Fin estan presentes
                        results.push({
                          ID: id,
                          Depart: adjacentData[2],
                          Turno: "Matutino",
                          Inicio: formattedInicioMatutino,
                          Fin: formattedFinMatutino,
                        });
                      }
  
                      // Verificar si los campos de "Inicio" y "Fin" para periodo 2 estan presentes
                      if (
                        (adjacentData[6] || adjacentData[6] === "Falta") &&
                        (adjacentData[7] || adjacentData[7] === "Falta")
                      ) {
                        const formattedInicioVespertino = adjacentData[6] && adjacentData[6] !== "Falta" 
                          ? `${formattedDate}T${formatTimeToTwoDigits(adjacentData[6])}:00` 
                          : `${formattedDate}T01:00:00`;
                        const formattedFinVespertino = adjacentData[7] && adjacentData[7] !== "Falta" 
                          ? `${formattedDate}T${formatTimeToTwoDigits(adjacentData[7])}:00` 
                          : `${formattedDate}T01:00:00`;
  
                        // Agregar datos periodo 2 solo si Inicio o Fin estan presentes
                        results.push({
                          ID: id,
                          Depart: adjacentData[2],
                          Turno: "Vespertino",
                          Inicio: formattedInicioVespertino,
                          Fin: formattedFinVespertino,
                        });
                      }
                    }
                  }
                  break;
                }
              }
  
              if (columnIndexID === -1) {
                console.log("No se encontró la columna 'ID'.");
              }
  
              output.innerHTML = JSON.stringify(results, null, 2);
              enviarDatos(results); // Envia los datos al servidor
            } else {
              output.innerHTML = `<p>La hoja con el nombre "${sheetNameToFind}" no se encontró en el archivo.</p>`;
            }
          } catch (error) {
            console.error("Error al procesar el archivo:", error);
            document.getElementById("output").innerText =
              "Hubo un error al procesar el archivo. Por favor, inténtalo de nuevo.";
          }
        };
        reader.readAsArrayBuffer(selectedFile);
      }
  
      function enviarDatos(datos) {
        const validDatos = datos.filter(dato => dato.Depart && dato.Depart.trim() !== "");
        if (validDatos.length === 0) {
          alert("No hay datos válidos para enviar.");
          return;
        }
  
        fetch("/asistencias/procesarAsistencias", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(validDatos)
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log("Respuesta del servidor:", data);
            alert(data.mensaje);
          })
          .catch(error => {
            console.error("Error al enviar datos:", error);
            alert("Error al enviar datos.");
          });
      }
    });
  </script>
  
</body>

</html>