<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>SICE: Asignación de Materias</title>
    <link rel="icon" type="image/x-icon" th:href="@{/imagenes/INSIBO.ico}">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
</head>
<body>
    <header th:replace="~{home :: header}"></header>

    <div class="container mb-2">
        <!--Indicación de la ubicación de la página actual-->
        <div class="container col-8 mt-4 d-flex justify-content-start flex-wrap">
            <nav class="mt-5" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a th:href="@{/administracion}"class="text-decoration-none text-secondary">Administración</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:href="@{/GestionMaterias}"class="text-decoration-none text-secondary">Materias</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Asignaciones</li>
                </ol>
            </nav>
        </div>
        <!-- TITULO PRINCIPAL -->
        <div class="d-flex justify-content-center mb-3 flex-wrap">
            <h3 class="text-center">
                <b th:text="${titulo}"></b>
            </h3>
        </div>

        <div class="col-8 mx-auto">
            <div class="d-flex justify-content-end mb-2">
                <!-- Botón Nueva Asignación -->
                <a class="btn btn-primary" th:href="@{/NuevaAsignacion/}+${idMateria}">Nueva Asignacion</a>
            </div>
            
            <table class="table table-responsive table-hover">
                <thead>
                    <tr>
                        <th class="text-center">Bachillerato</th>
                        <th class="text-center">Profesor</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Iteración sobre las asignaciones -->
                    <tr th:each="asignacion : ${asignaciones}">
                        <td class="text-center" th:text="${asignacion.bachillerato.grado + '° año ' + asignacion.bachillerato.nombreCarrera + ' &quot;' + asignacion.bachillerato.seccion + '&quot;' }"></td>
                        <td class="text-center" th:text="${asignacion.docente.nombreDocente + ' ' + asignacion.docente.apellidoDocente}"></td>
                        <td class="text-center align-middle" style="width: 20%;">
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-primary btn-sm mx-1 editar-btn" data-bs-toggle="modal" data-bs-target="#actualizarMateriaModal"
                                        th:data-id="${asignacion.idAsignacion}" 
                                        th:data-id-materia="${asignacion.materia.idMateria}"
                                        th:data-materia="${asignacion.materia.nomMateria}"
                                        th:data-profesor="${asignacion.docente.duiDocente}"
                                        th:data-cod-bachillerato="${asignacion.bachillerato.grado + '° año ' + asignacion.bachillerato.nombreCarrera + ' &quot;' + asignacion.bachillerato.seccion + '&quot;' }">
                                    <i class="bi bi-pencil-square"></i>
                                </button>                                
                                <a class="btn btn-danger btn-sm mx-1 delete-btn" 
                                    th:href="@{/eliminarAsignacion(idMateria=${asignacion.materia.idMateria}, idAsignacion=${asignacion.idAsignacion})}" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="top" 
                                    title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                 </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div th:if="${asignaciones.totalPages == 0}" class="alert alert-info d-flex align-items-center" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" role="img" class="bi bi-exclamation-triangle-fill me-2" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                  </svg>
                <div>
                    ¡No se han encontrado asignaciones disponibles!
                </div>
            </div>

            <!-- Contenedor de navegación para la paginación -->
            <nav aria-label="Paginación" th:if="${asignaciones.totalPages > 1}">
                <ul class="pagination justify-content-center">
                    <!-- Botón para anterior -->
                    <li th:classappend="${asignaciones.hasPrevious()} ? 'page-item' : 'page-item disabled'">
                        <a class="page-link" th:href="@{'/AsignacionMateria/' + ${idMateria} + '?pagina=' + ${asignaciones.number}}">Anterior</a>
                    </li>

                    <!-- Páginas intermedias -->
                    <li th:each="i : ${#numbers.sequence(1, asignaciones.totalPages)}" th:classappend="${asignaciones.number + 1 == i} ? 'page-item active' : 'page-item'">
                        <a class="page-link" th:href="@{'/AsignacionMateria/' + ${idMateria} + '?pagina=' + ${i}}" th:text="${i}"></a>
                    </li>

                    <!-- Botón para siguiente -->
                    <li th:classappend="${asignaciones.hasNext()} ? 'page-item' : 'page-item disabled'">
                        <a class="page-link" th:href="@{'/AsignacionMateria/' + ${idMateria} + '?pagina=' + ${asignaciones.number+2}}">Siguiente</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Modal para actualizar asignación -->
    <div class="modal fade" id="actualizarMateriaModal" tabindex="-1" aria-labelledby="actualizarMateriaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actualizarMateriaModalLabel">Editar Asignación de Materia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editarAsignacionForm" method="post" th:action="@{/actualizarAsignacion}" class="needs-validation" novalidate>
                        <input type="hidden" id="idAsignacion" name="idAsignacion">
                        <input type="hidden" id="editarIdMateria" name="idMateria"> <!-- Añadido para enviar idMateria -->
                        <div class="mb-3">
                            <label for="editarMateria" class="form-label">Materia</label>
                            <input type="text" class="form-control" id="editarMateria" name="materia" readonly required>
                        </div>
                        <div class="mb-3">
                            <label for="editarBachillerato" class="form-label">Bachillerato</label>
                            <input type="text" class="form-control" id="editarBachillerato" name="bachillerato" readonly required>
                        </div>
                        <div class="mb-3">
                            <label for="profesor" class="form-label">Profesor</label>
                            <select class="form-select" id="profesor" name="duiDocente" required>
                                <option value="">Seleccionar docente...</option>
                                <option th:each="docente : ${docentes}"
                                    th:value="${docente.duiDocente}"
                                    th:text="${docente.nombreDocente} + ' ' + ${docente.apellidoDocente}">
                                </option>
                            </select>
                            <div class="invalid-feedback">Por favor, seleccione el docente.</div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Actualizar</button>
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </form>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" th:src="@{/js/gestionAsignacion.js}"></script>
</body>
</html>
