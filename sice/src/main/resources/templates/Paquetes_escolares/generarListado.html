<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{home :: head}">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <title th:text="${pageTitle}">Título por Defecto</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>

<body>
  <header th:replace="~{home :: header}"></header>
  <div class="p-4 mt-5">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a th:href="@{/}">Inicio</a></li>
          <li class=" breadcrumb-item active" aria-current="page">Listado entrega</li>
        </ol>
      </nav>
    </div>
    <h2 class="text-center">Generación Listado</h2>
    <!-- Mensajes -->
    <div class="alert alert-success alert-dismissible fade show mt-1 mx-2" th:if="${success != null}">
      <i class="bi bi-check-circle"></i>
      <label th:text="${success}"></label>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="alert alert-danger alert-dismissible fade show mt-1 mx-2" th:if="${error != null}">
      <i class="bi bi-exclamation-triangle"></i>
      <label th:text="${error}"></label>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="alert alert-warning alert-dismissible fade show mt-1 mx-2" th:if="${warning != null}">
      <i class="bi bi-info-circle"></i>
      <label th:text="${warning}"></label>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <!-- Mensajes -->
    <div class="d-flex justify-content-end">
      <div>
        <div>
          <a th:href="@{/entregasPaquetes/reportesEntrega/{id}(id=${id})}" class="btn btn-success">Reportes Entrega</a>
        </div>
      </div>
    </div>
    <form th:action="@{/entregasPaquetes/seccion/{id}(id=${id})}" method="get" class="needs-validation" novalidate>
      <div class="d-flex justify-content-end p-2">
        <div class="row mx-2">
          <select name="tipoPaquete" id="tipoPaquete" class="form-select" required>
            <option value="">Seleccionar tipo de paquete</option>
            <option value="paqueteZapatos" disabled>Paquetes Zapatos</option>
            <option value="paqueteUtiles" disabled>Paquetes Utiles</option>
            <option value="paqueteUniforme" disabled>1° Paquete Uniforme</option>
            <option value="paqueteUniforme" disabled>2° Paquete Uniforme</option>
        </select>
        </div>
        <button type="submit" class="btn btn-primary" id="btn-generar" disabled>Generar listado</button>
      </div>
    </form>
    <form th:action="@{/entregasPaquetes/entregarPaquete}" method="post">
      <input type="hidden" name="id" th:value="${id}" id="id" />
      <input type="hidden" name="tipoPaquete" th:value="${tipoPaquete}" />
      <!-- Encabezado del Bachillerato -->
      <div class="d-flex justify-content-end" th:if="${alumnos}">
        <div>
          <a th:href="@{/entregasPaquetes/imprimirListado/{id}(id=${id}, tipoPaquete=${tipoPaquete})}"
            class="btn btn-secondary me-2" target="_blank" onclick="openInPopup(this.href); return false;">
            <i class="bi bi-printer"></i> Imprimir
          </a>
        </div>
      </div>
      <table class="table table-bordered" th:if="${alumnos}">
        <thead>
          <tr>
            <th class="fs-3" colspan="7" th:text="${bachillerato.nombreCarrera}">Nombre del Bachillerato</th>
          </tr>
        </thead>
        <tbody>
          <!-- Tipo de Paquete -->
          <tr>
            <td class="fs-4 fw-bolder" colspan="7" th:if="${tipoPaquete == 'paqueteZapatos'}">
              Paquete de Zapatos
            </td>
            <td class="fs-4 fw-bolder" colspan="7" th:if="${tipoPaquete == 'paqueteUtiles'}">
              Paquete de Útiles Escolares
            </td>
            <td class="fs-4 fw-bolder" colspan="7" th:if="${tipoPaquete == 'paqueteUniforme'}">
              Paquete de Uniforme Escolar
            </td>
          </tr>
          <tr>
            <td colspan="7" class="fs-5"
              th:text="'Año: ' + ${bachillerato.grado} + '° Sección: ' + ${bachillerato.seccion}">
              Año y Sección
            </td>
          </tr>
          <tr class="align-middle">
            <th>#</th>
            <th>NIE</th>
            <th>Apellido</th>
            <th>Nombre</th>
            <th>Género</th>
            <th th:if="${tipoPaquete == 'paqueteZapatos' || tipoPaquete == 'paqueteUniforme'}">
              Talla
            </th>
            <th>Acción</th>
          </tr>
          <tr class="align-middle" th:each="alumno, iter : ${alumnos}">
            <input type="hidden" name="alumnoId" th:value="${alumno.idAlumno}" />
            <td th:text="${iter.index + 1}"></td>
            <td th:text="${alumno.nie}"></td>
            <td th:text="${alumno.apellidoAlumno}"></td>
            <td th:text="${alumno.nombreAlumno}"></td>
            <td th:text="${alumno.sexoAlumno}"></td>
            <!-- Campo Talla (Solo si no es paquete de utiles escolares) -->
            <td th:if="${tipoPaquete == 'paqueteZapatos'}">
              <div class="row">
                <label for="talla" class="form-label col my-auto">Talla:</label>
                <div class="col">
                  <input type="number" th:name="'talla_'+ ${alumno.idAlumno}" th:id="'talla_' + ${alumno.idAlumno}"
                    class="form-control" min="1" required />
                </div>
              </div>
            </td>
            <td th:if="${tipoPaquete == 'paqueteUniforme'}">
              <div class="row">
                <label for="talla" class="form-label col my-auto">Talla:</label>
                <div class="col">
                  <input type="text" th:name="'talla_' + ${alumno.idAlumno}" th:id="'talla_' + ${alumno.idAlumno}"
                    class="form-control" required />
                </div>
              </div>
            </td>
            <!-- Checkbox para indicar si se entrego el paquete -->
            <td>
              <div class="form-check d-flex justify-content-center">
                <input class="form-check-input me-2 border border-2 border-secondary" type="checkbox"
                  th:name="'entregado_' + ${alumno.idAlumno}" th:id="'entregado_' + ${alumno.idAlumno}"
                  checked="checked">
                <label class="form-check-label" th:for="'entregado_' + ${alumno.idAlumno}">Entregado</label>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Boton de Ingreso -->
      <div class="d-flex justify-content-end" th:if="${alumnos}">
        <input type="submit" value="Ingresar" class="btn btn-success">
      </div>
    </form>
    <script>
      function openInPopup(url) {
        window.open(url, 'popup', 'width=800,height=600');
      }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      $(document).ready(function () {

        var idBachillerato = document.getElementById("id").value;
        console.log(idBachillerato)

        $.ajax({
          url: '/entregasPaquetes/fechasPaquetesContar/' + idBachillerato,
          type: 'GET',
          success: function (data) {
            console.log("zapatos" + data.zapatos)
            if (data.zapatos > 0) {
              $('#tipoPaquete option[value="paqueteZapatos"]').prop('disabled', true);
            } else {
              $('#tipoPaquete option[value="paqueteZapatos"]').prop('disabled', false);
            }
            console.log("utiles" + data.utiles)
            if (data.utiles > 0) {
              $('#tipoPaquete option[value="paqueteUtiles"]').prop('disabled', true);
            } else {
              $('#tipoPaquete option[value="paqueteUtiles"]').prop('disabled', false);
            }

            // Manejo de las opciones "Paquetes Uniforme"
            console.log("uniforme" + data.uniformes)
            if (data.uniformes == 1) {
              // Si hay solo 1 registro de uniformes, deshabilita el primer paquete, pero habilita el segundo
              $('#tipoPaquete option[value="paqueteUniforme"]').eq(0).prop('disabled', true);
              $('#tipoPaquete option[value="paqueteUniforme"]').eq(1).prop('disabled', false);
            } else if (data.uniformes >= 2) {
              // Si hay 2 o más registros de uniformes, deshabilita ambos paquetes
              $('#tipoPaquete option[value="paqueteUniforme"]').eq(0).prop('disabled', true);
              $('#tipoPaquete option[value="paqueteUniforme"]').eq(1).prop('disabled', true);
            } else {
              // Si no hay registros de uniformes, deshabilita el segundo paquete, pero habilita el primero
              $('#tipoPaquete option[value="paqueteUniforme"]').eq(0).prop('disabled', true);
              $('#tipoPaquete option[value="paqueteUniforme"]').eq(1).prop('disabled', false);
            }
          }
        });
      });
    </script>
    <script>
      let select_paquete = document.getElementById("tipoPaquete");
      let btn_paquete = document.getElementById("btn-generar");
      select_paquete.addEventListener("change", ()=>{
        if(select_paquete.value != ""){
          console.log(select_paquete.value);
          btn_paquete.disabled = false;
        }else{
          btn_paquete.disabled = true;
        }
      })
    </script>
</body>

</html>